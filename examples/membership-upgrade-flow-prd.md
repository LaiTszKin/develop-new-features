# PRD：會員升級流程優化

- 日期：2026-02-07
- 功能名稱：會員升級流程優化
- 需求摘要：讓會員在升級方案時可預覽差異、保留既有權益並即時生效。

## Reference

- 參考文件：
  - `references/prd-template.md`
  - `references/testing-unit.md`
  - `references/testing-property-based.md`
  - `references/testing-integration.md`
- 需要修改/新增的檔案：
  - `apps/web/src/features/billing/upgrade.ts`
  - `apps/api/src/modules/billing/upgrade.service.ts`
  - `apps/api/src/modules/billing/upgrade.controller.ts`
  - `apps/api/tests/billing/upgrade.integration.test.ts`

## 核心需求

- [ ] 系統必須在會員選擇新方案時顯示「原方案 vs 新方案」權益差異。
- [ ] 系統必須以比例計算未使用額度折抵，避免重複收費。
- [ ] 系統必須在付款成功後 10 秒內更新會員等級與可用權益。
- [ ] 系統應該在升級失敗時保留原方案，不得改動現有權限。
- [ ] 系統必須記錄升級事件與付款交易 ID 以供稽核。

## 業務邏輯流程

1. 使用者在帳務頁點擊「升級方案」。
   - 觸發條件：登入且具有可升級資格
   - 輸入：目前方案、目標方案
   - 輸出：方案差異、折抵金額、應付金額
   - 例外/失敗：若目標方案已是現行方案，顯示不可重複升級
2. 使用者確認並送出付款。
   - 觸發條件：使用者確認應付金額
   - 輸入：付款方式、訂單資料
   - 輸出：付款結果（成功/失敗）
   - 例外/失敗：付款失敗時回傳錯誤原因並可重試
3. 系統完成方案切換與權益同步。
   - 觸發條件：付款成功 webhook 抵達
   - 輸入：交易 ID、訂單 ID
   - 輸出：會員等級更新、權益生效、事件紀錄
   - 例外/失敗：同步失敗時進入補償佇列並告警

## 需要澄清的問題

- 升級折抵是否包含贈送點數，或僅限於付費額度？
- 若使用者同時有折扣碼，折扣套用順序是先折抵再打折，或相反？
- 付款成功後若 webhook 延遲超過 10 秒，是否需要前端顯示「處理中」狀態？

## 測試規劃

### 測試原則與參考

- 單元測試原則：`references/testing-unit.md`
- Property-based 測試原則：`references/testing-property-based.md`
- 整合測試原則：`references/testing-integration.md`
- E2E 測試原則（僅在使用者要求時）：`references/testing-e2e.md`

### 單元測試案例

| ID | 情境 | 期望結果 | 目的 |
| --- | --- | --- | --- |
| UT-01 | 目標方案價格高於現方案，且有未使用天數 | 應付金額 = 新方案差額 - 折抵金額 | 驗證折抵公式正確，避免多收費 |
| UT-02 | 升級目標與現方案相同 | 回傳不可重複升級錯誤 | 避免重複訂單與資料污染 |
| UT-03 | 付款失敗 | 不更新會員等級 | 確保失敗時狀態一致性 |

### Property-based 測試案例

| ID | 性質/不變量 | 生成策略 | 目的 |
| --- | --- | --- | --- |
| PBT-01 | 任意有效價格與折抵組合下，應付金額不得為負數 | 隨機生成方案價格、剩餘天數、折抵比例 | 保證計費結果數學一致性 |
| PBT-02 | 付款失敗狀態下，會員等級永遠不改變 | 隨機生成交易狀態序列（成功/失敗/逾時） | 保證失敗路徑資料安全 |

### 整合測試案例（如需）

| ID | 依賴/範圍 | 情境 | 目的 |
| --- | --- | --- | --- |
| IT-01 | Billing API + Payment Webhook | 付款成功後完成升級 | 驗證跨服務流程可成功閉環 |
| IT-02 | Billing API + Event Bus | 升級後事件寫入稽核流 | 確保可追蹤與可稽核 |

### E2E 測試案例（僅在使用者要求時）

不適用（未被要求）。
